# Introduction
eShopOnContainers supports deployment to Kubernetes clusters for "simulated" production scenarios where you need to scale-out your containers.
Currently, eShopOnContainers supports [AKS (Azure Kubernetes Service)](https://docs.microsoft.com/en-us/azure/aks/intro-kubernetes) and [ACS-Kuberentes (Azure Container Service for Kuberentes)](https://docs.microsoft.com/en-us/azure/container-service/kubernetes/container-service-intro-kubernetes), but we recommend to use AKS since ACS will be deprecated in the future favoring AKS which offers further PaaS features for the cluster's infrastructure, automatic updates/patch on the VMs, etc.
 
Common info for eShopOnContainers on Kuberentes (including both environments, AKS and ACS) is available [here](https://github.com/dotnet-architecture/eShopOnContainers/blob/dev/k8s/README.k8s.md)

However, this post focuses specifically on AKS (Azure Kubernetes Service) deployment of eShopOnContainers, with further details.

# Prerequisites

### A Docker development environment with `docker` and `docker-compose`.

Visit [docker.com](https://docker.com) to download the tools and set up the environment. Docker's [installation guide](https://docs.docker.com/engine/getstarted/step_one/#step-3-verify-your-installation) covers verifying your Docker installation.

### Azure cli 2.0 or later
Azure cli 2.0 or later must be installed in your dev machine [installation guide](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli). 

###  The Kubernetes command line client, `kubectl`.
`kubectl` can be installed with the `az` tool as described in the AKS [walkthrough](https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough#connect-to-the-cluster). `az` is also helpful for getting the credentials `kubectl` needs to access your cluster. For other installation options, and information about configuring `kubectl` yourself, see the [Kubernetes documentation](https://kubernetes.io/docs/tasks/kubectl/install/).

## Option A: Manually create the infrastructure in Azure

### A Kubernetes cluster in AKS. 
You can follow any of the following approaches in order to create a Kubernetes cluster in AKS:

* A. Create an AKS cluster with Azure portal: [Walkthrough](https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough-portal)

* B. Create an AKS cluster with Azure CLI: [Walkthrough](https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough)

### A private Azure Container Registry (ACR)

[ACR](https://docs.microsoft.com/en-us/azure/container-registry/container-registry-intro) is a managed Docker registry service based on the open-source Docker Registry 2.0. With ACR you create and maintain Azure container registries to store and manage your private Docker container images.

It is important to have a Docker registry, holding your private images, located in the same Datacenter/area than your orchestrator cluster, so when pulling images it'll go faster than if you use a remote Docker registry like Docker Hub. In addition, ACR offers significant value-added like global availability and global replication, etc.
You can follow any of the following approaches:

* A. Create an ACR registry with Azure portal: [Walkthrough](https://docs.microsoft.com/en-us/azure/container-registry/container-registry-get-started-portal)

* B. Create an ACR registry with Azure CLI: [Walkthrough](https://docs.microsoft.com/en-us/azure/container-registry/container-registry-get-started-azure-cli)

## Option B: Automatically create all the infrastructure in Azure with a ready-to-go script

Create ALL the Azure infrastructure with an eShopOnContainer's ready-to-go script.
All previous steps related to Azure infrastructure can be skipped if you run the **gen-k8s-env-aks.ps1** script to automatically create the Azure environment needed for the Kubernetes deployment. That includes the AKS cluster and optionally the ARC container registry.

For example just by running the following cli script it would create to create the AKS cluster.

>```
>./gen-k8s-env-aks -resourceGroupName YoureShopAksResgroup -location centralus -serviceName YoureShopAksCluster -dnsNamePrefix youreshopaks -registryName YoureShopAcrRegistry -createAcr true -nodeCount 3 -nodeVMSize Standard_D2_v2
>```

**Important**: Note the parameter "-createAcr true". If you are creating the K8s cluster but you want to re-use and existing ACR, say "-createAcr false".

### Step-by-step procedure

* Authenticate in Azure using the CLI
Before running the eShopOnContainers **gen-k8s-env-aks.ps1** script or manually creating the clusters, you first need to authenticate from a PowerShell window, with:
`az login`
Follow the procedure.

* Select the right Azure subscription to use
It is very common to have access to multiple Azure subscriptions. 
You can list your available subscriptions with:

`az account list -o table`

And check which subscription is being used by default.
If you need to change it, do it with this command:

`az account setÂ --subscription "YOUR-SUBSCRIPTION-NAME"`

* Run the script to create the Kubernetes cluster (and optionally the ACR registry) in Azure 
Open PowerShell and position in the folder where the script is placed:

`cd <YOUR-PATH>\eShopOnContainers\k8s`

Run the following script:

>```
>./gen-k8s-env-aks -resourceGroupName YoureShopAksResgroup -location centralus -serviceName YoureShopAksCluster -dnsNamePrefix youreshopaks -registryName YoureShopAcrRegistry -createAcr true -nodeCount 3 -nodeVMSize Standard_D2_v2
>```

You should get a similar execution in PowerShell, as the following:

![image](https://user-images.githubusercontent.com/1712635/40207708-cd483e3c-59ea-11e8-9698-e5e7e97e712b.png)

After a successful execution you can check the AKS Kubernetes cluster in Azure portal, like in the following screenshot:

![image](https://user-images.githubusercontent.com/1712635/40206473-10327e02-59e5-11e8-90d6-d1fcfaa9b4a4.png)


# Check your Kubernetes Cluster Dashboard

To open your Kubernetes dashboard, complete the following steps:

* Open Azure CLI version 2.0.27 or later in PowerShell or CommandLine window. This will not work in cloud shell and must be running on your local machine. 

* If you do not already have `kubectl` installed in your CLI, run the following command:
NOTE: Make sure you run with admin privileges so you don't get a "Permission denied: C:\\Program Files (x86)\\kubectl.exe". 
  
>```
>az aks install-cli
>```

![image](https://user-images.githubusercontent.com/1712635/40207409-3bbddacc-59e9-11e8-981e-6193fd66ddda.png)

* Get the credentials for your cluster by running the following command:

>```
>az aks get-credentials --resource-group YoureShopAksResgroup --name YoureShopAksCluster
>```

![image](https://user-images.githubusercontent.com/1712635/40207443-61aaf71a-59e9-11e8-9765-6baaa03746d0.png)

* Open the Kubernetes dashboard by running the following command:

>```
>az aks browse --resource-group YoureShopAksResgroup --name YoureShopAksCluster
>```

This command runs the Kubernetes proxy (so you can access the remote dashboard through the 127.0.0.1 IP) while it opens the dashboard in a browser. You could also do those steps manually, though.
You should see the Kubernetes dashboard, similar to the following screenshot if you click on the nodes menu option:

![image](https://user-images.githubusercontent.com/1712635/40207519-c6c2e4e6-59e9-11e8-8f9e-60f6a15ef3ab.png)

## Important: Store your credentials/secrets for Kubernetes and ACR in a safe place!

The script and Azure CLI create all the infrastructure very easily. However, if you want to re-use the same Kubernetes credentials or re-use the same Azure ACR registry, it is important that you store your credentials in a safe place.

## Kubernetes credentials

TBD

## ACR credentials

TBD

# Deploy the eShopOnContainers application into the Kuberentes cluster with the deployment script

1. Open a PowerShell command line at the `k8s` directory of your local eShopOnContainers repository.
1. Ensure `docker`, `docker-compose`, and `kubectl` are on the path, and configured for your Docker machine and Kubernetes cluster.
1. Run `deploy.ps1` with your registry information. The Docker username and password are provided by Azure Container Registry, and can be retrieved from the Azure portal. Optionally, ACR credentials can be obtained by running the following command:

>```
>az acr credential show -n eshopregistry
>```

Once the user and password are retrieved, run the following script for deployment. For example:

>```
>./deploy.ps1 -registry myregistry.azurecr.io -dockerUser User -dockerPassword SecretPassword -configFile file_with_config.yaml
>```

The parameter `configFile` is important (and mandatory) because it contains the configuration used for the Pods in Kubernetes. This allow deploying Pods that use your own resources in Azure or any other cloud provider. A configuration file `conf_local.yaml` is provided which configures Pods to use the infrastructure containers (that is sql server, rabbitmq, redis and mongodb must be deployed also in the k8s).

The script will build the code and corresponding Docker images, push the later to your registry, and deploy the application to your cluster. You can watch the deployment unfold from the Kubernetes web interface: run `kubectl proxy` and open a browser to [http://localhost:8001/ui](http://localhost:8001/ui)

### Pods configuration file

When deploying to k8s the script needs the `configFile` parameter with the location of the YAML configuration file. This file contains the configuration of the pods. The file is a .YAML file. For reference another configuration file (conf_cloud.yaml) is provided but without valid values.

If you deploy the infrastructure containers use `conf_local.yaml` as a value for `configFile` parameter. If you don't deploy the infrastructure containers use your own configuration file with the correct values.

### Parameters of the deploy.ps1 script

The script accepts following parameters:

+ `registry`: Name of the Docker registry to use. If not passed DockerHub is assumed
+ `dockerUser`: Login to use for the Docker registry (if needed)
+ `dockerPassword`: Password to use for the Docker registry (if needed)
+ `execPath`: Location of `kubectl` (if not in the path). If passed must finish with the path character.
+ `kubeconfigPath`: Location of the `kubectl` configuration file. **This parameter is used only in the CI pipeline**, so you don't need to pass it when invoking the script using the CLI.
+ `configFile`: Location of the Yaml file with the `externalcfg` configmap to be deployed. This configmap is used to configure the Pod's environment **This parameter is mandatory**
+ `imageTag`: Tag of the images to deploy to k8s. If not passed the name of the current branch is used.
+ `externalDns`: External DNS name of the k8s. This is only needed if you have configured a DNS that points to your k8s external IP. If you don't have any DNS configured do not pass this parameter.
+ `deployCI`: If `true` means that script is running under the context of a VSTS Hosted Build Agent. **You should never use this parameter from CLI**
+ `buildBits`: means that the source code of eShopOnContainers will be built. If you have built your code (and have all projects published in `obj/Docker/publish`) do not pass this parameter. Default value is `false`
+ `buildImages`: If `true` (default value) Docker images are built and pushed in the Docker registry. If you set this parameter to `false`, Docker images won't be built nor pushed in the Docker registry (but k8s' deployments and services will be redeployed).
+ `deployInfrastructure`: If `true` infrastructure containers (rabbitmq, mongo, redis, sql) will be deployed in k8s. If `false` those containers (and its related deployments and services in k8s) won't be deployed.
+ `dockerOrg`: Name of the organization in the registry where the images are (or will be pushed). Default value is `eshop` (which has images provided by Microsoft)

**Important:** If you **don't pass the `-buildBits $true` the script won't build and publish the projects** to their `obj/Docker/publish` folder. If any project is not published, you'll be receiving errors like:

```
ERROR: Service 'xxxxxxx' failed to build: COPY failed: stat /var/lib/docker/tmp/docker-builder123456789/obj/Docker/publish: no such file or directory
```

### Typical usages of the script:

Build all projects, and deploy all them in k8s including infrastructure containers in a organization called `foo` in Docker Hub. Images will be tagged with my current git branch and containers will use the configuration set in `conf_local.yml` file:

```
./deploy.ps1 -buildBits $true -dockerOrg foo -dockerUser MY_USER -dockerPassword MY_PASSWORD -configFile conf_local.yml
```

Do not build any project and don't rebuild docker images. Create k8s deployments that will pull images from my private repository, in the `foo` organization, using the tag `latest`. Containers will use the configuration set in `conf_cloud` file.

```
./deploy.ps1 -buildImages $false -dockerOrg foo -registry MY_REGISTRY_FQDN -dockerUser MY_USER -dockerPassword MY_PASSWORD -configFile conf_cloud.yml -imageTag master
```

Deploy k8s using public images that Microsoft provides:

```
./deploy.ps1 -buildImages $false -configFile conf_local.yml -imageTag master
```






